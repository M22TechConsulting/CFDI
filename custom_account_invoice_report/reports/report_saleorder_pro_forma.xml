<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <record id="sale.action_report_pro_forma_invoice" model="ir.actions.report">
            <field name="paperformat_id" ref="custom_account_invoice_report.custom_invoice_report_pdf_vertical"/>
        </record>

        <template id="custom_proforma_report_saleorder_document" inherit_id="sale.report_saleorder_pro_forma">
            <xpath expr="//t" position="replace">
                <t t-call="web.html_container">
                    <t t-set="is_pro_forma" t-value="True"/>
                    <t t-set="docs" t-value="docs.with_context(proforma=True)"/>
                    <t t-foreach="docs" t-as="doc">

                        <style>
                            table, th, td, tr, thead, tbody{
                            border: none;
                            }
                        </style>
                        <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)"/>
                        <t t-set="forced_vat"
                           t-value="doc.fiscal_position_id.foreign_vat"/> <!-- So that it appears in the footer of the report instead of the company VAT if it's set -->
                        <t t-set="address">
                            <div t-field="doc.partner_id"
                                 t-options="{&quot;widget&quot;: &quot;contact&quot;, &quot;fields&quot;: [&quot;address&quot;, &quot;name&quot;], &quot;no_marker&quot;: True}"/>
                            <p t-if="doc.partner_id.vat"><t
                                    t-out="doc.company_id.account_fiscal_country_id.vat_label or 'Tax ID'"/>:
                                <span t-field="doc.partner_id.vat"/>
                            </p>
                        </t>

                        <t t-call="custom_account_invoice_report.report_header_document_custom"/>

                        <div class="article o_report_layout_standard" t-att-data-oe-model="doc and doc._name" t-att-data-oe-id="doc and doc.id"
                             t-att-data-oe-lang="doc and doc.env.context.get('lang')">
                            <t t-out="0"/>
                            <div style="padding-top:130px;" class="page">

                                <!--Datos de los productos-->
                                <!--___________________________________________________________-->
                                <t t-set="lines_to_report" t-value="doc._get_order_lines_to_report()"/>
                                <t t-set="display_discount" t-value="any(l.discount for l in lines_to_report)"/>

                                <table width="100%" style="border-collapse:collapse;"
                                       class="table table-sm o_main_table"
                                       name="sale_line_table">
                                    <thead style="font-size: 14px;">
                                        <tr>
                                            <th name="th_quantity" class="text-center">
                                                <span>Cantidad</span>
                                            </th>
                                            <th name="th_uom" class="text-center">
                                                <span>Unidad</span>
                                            </th>
                                            <th name="th_uom_key" class="text-start">
                                                <span>Clave Unidad</span>
                                            </th>
                                            <th name="th_sat_key" class="text-center">
                                                <span>Clave Prod. Serv</span>
                                            </th>
                                            <th name="th_description" class="text-start">
                                                <span>Descripción</span>
                                            </th>
                                            <th name="th_price_unit"
                                                t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                                <span>Disc.%</span>
                                            </th>
                                            <th name="th_priceunit"
                                                t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                                <span>
                                                    P/U
                                                </span>
                                            </th>
                                            <th name="th_subtotal" class="text-end">
                                                <span groups="account.group_show_line_subtotals_tax_excluded">Importe
                                                </span>
                                                <span groups="account.group_show_line_subtotals_tax_included">Importe
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody style="font-size: 12px;" class="invoice_tbody">
                                        <t t-set="current_subtotal" t-value="0"/>
                                        <t t-foreach="lines_to_report" t-as="line">
                                            <t t-set="current_subtotal"
                                               t-value="current_subtotal + line.price_subtotal"/>
                                            <t t-set="current_subtotal" t-value="current_subtotal + line.price_total"/>

                                            <tr style="border:none;"
                                                t-att-class="'bg-200 fw-bold o_line_section' if line.display_type == 'line_section' else 'fst-italic o_line_note' if line.display_type == 'line_note' else ''">
                                                <t name="account_invoice_line_accountable">
                                                    <td class="text-center">
                                                        <span t-field="line.product_uom_qty"/>
                                                    </td>
                                                    <td class="text-center">
                                                        <span t-field="line.product_uom"/>
                                                    </td>
                                                    <td class="text-start">
                                                        <span t-field="line.product_uom.unspsc_code_id.code"/>
                                                    </td>
                                                    <td class="text-start">
                                                        <span t-field="line.product_id.unspsc_code_id.code"/>
                                                    </td>
                                                    <td name="account_invoice_line_name">
                                                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                                    </td>
                                                    <td t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                                        <span class="text-nowrap" t-field="line.discount"/>
                                                    </td>
                                                    <td t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                                                        <span class="text-nowrap" t-field="line.price_unit"/>
                                                    </td>
                                                    <td class="text-end o_price_total">
                                                        <span class="text-nowrap" t-field="line.price_subtotal"
                                                              groups="account.group_show_line_subtotals_tax_excluded"/>
                                                        <span class="text-nowrap" t-field="line.price_total"
                                                              groups="account.group_show_line_subtotals_tax_included"/>
                                                    </td>
                                                </t>
                                                <t t-if="line.display_type == 'line_section'">
                                                    <td colspan="99">
                                                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                                    </td>
                                                    <t t-set="current_section" t-value="line"/>
                                                    <t t-set="current_subtotal" t-value="0"/>
                                                </t>
                                                <t t-if="line.display_type == 'line_note'">
                                                    <td colspan="99">
                                                        <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                                    </td>
                                                </t>
                                            </tr>
                                            <tr t-if="doc._get_product_lot_ids(line.product_id)"
                                                style="border:none;justify-content: normal;">
                                                <t t-set="lot_ids" t-value="list()"/>
                                                <td colspan="99">
                                                    <t t-foreach="doc._get_product_lot_ids(line.product_id)" t-as="lot">
                                                        <span t-esc="lot"/>
                                                        <span>   </span>
                                                    </t>
                                                </td>
                                            </tr>

                                            <t t-elif="line.display_type == 'line_section'">
                                                <td name="td_section_line" colspan="99">
                                                    <span t-field="line.name"/>
                                                </td>
                                                <t t-set="current_section" t-value="line"/>
                                                <t t-set="current_subtotal" t-value="0"/>
                                            </t>
                                            <t t-elif="line.display_type == 'line_note'">
                                                <td name="td_note_line" colspan="99">
                                                    <span t-field="line.name"/>
                                                </td>
                                            </t>

                                            <t t-if="current_section and (line_last or doc.order_line[line_index+1].display_type == 'line_section') and not line.is_downpayment">
                                                <tr class="is-subtotal text-end">
                                                    <td name="td_section_subtotal" colspan="99">
                                                        <strong class="mr16">Subtotal</strong>
                                                        <span t-out="current_subtotal"
                                                              t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                                                    </td>
                                                </tr>
                                            </t>
                                        </t>
                                    </tbody>
                                </table>

                                <div class="clearfix mb-4">
                                    <div id="total" class="row">

                                        <div width="80%"
                                             t-attf-class="#{'col-6' if report_type != 'html' else 'col-sm-7 col-md-6'} ms-auto">
                                            <table class="table table-sm" style="page-break-inside: avoid;">
                                                <t t-set="tax_totals" t-value="doc.tax_totals"/>

                                                <tr style="font-size:14px;">
                                                    <td>
                                                        <strong>Subtotal</strong>
                                                    </td>
                                                    <td class="text-end">
                                                        <span t-esc="'${0:,.2f}'.format(doc.amount_untaxed)"/>
                                                    </td>
                                                </tr>
                                                <tr style="font-size:14px;">
                                                    <t t-set="discount" t-value="0"/>
                                                    <t t-foreach="doc.order_line" t-as="disc_line">
                                                        <t t-set="discount"
                                                           t-value="discount + ((disc_line.discount / 100) * disc_line.price_unit * disc_line.product_uom_qty)"/>
                                                    </t>
                                                    <td>
                                                        <strong>Descuento</strong>
                                                    </td>
                                                    <td class="text-end">
                                                        <span t-esc="'${0:,.2f}'.format(discount)"/>
                                                    </td>
                                                </tr>
                                                <tr style="font-size:14px;" class="border-black o_total">
                                                    <td>
                                                        <strong>I.V.A</strong>
                                                    </td>
                                                    <td class="text-end">
                                                        <span t-esc="'${0:,.2f}'.format(doc.amount_tax)"/>
                                                    </td>
                                                </tr>

                                                <tr style="font-size:14px;" class="border-black o_total">
                                                    <td>
                                                        <strong>Total</strong>
                                                    </td>
                                                    <td class="text-end">
                                                        <span t-esc="tax_totals['formatted_amount_total']"/>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div t-if="doc.signature" class="mt-4 ml64 mr4" name="signature">
                                    <div class="offset-8">
                                        <strong>Signature</strong>
                                    </div>
                                    <div class="offset-8">
                                        <img t-att-src="image_data_uri(doc.signature)"
                                             style="max-height: 4cm; max-width: 8cm;"/>
                                    </div>
                                    <div class="offset-8 text-center">
                                        <p t-field="doc.signed_by"/>
                                    </div>
                                </div>

                                <div>
                                    <p t-field="doc.note" name="order_note"/>
                                    <p t-if="not is_html_empty(doc.payment_term_id.note)">
                                        <span t-field="doc.payment_term_id.note"/>
                                    </p>
                                    <p t-if="doc.fiscal_position_id and not is_html_empty(doc.fiscal_position_id.sudo().note)"
                                       id="fiscal_position_remark">
                                        <strong>Fiscal Position Remark:</strong>
                                        <span t-field="doc.fiscal_position_id.sudo().note"/>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div t-attf-class="footer o_standard_footer o_company_#{company.id}_layout">
                            <div class="text-center" style="border-top: 1px solid black;">
                                <ul class="list-inline mb4">
                                    <div t-field="company.report_footer"/>
                                </ul>

                                <div t-if="report_type == 'pdf'" class="text-muted">
                                    Page: <span class="page"/> / <span class="topage"/>
                                </div>
                            </div>
                        </div>


                    </t>
                </t>
            </xpath>
        </template>
    </data>
</odoo>