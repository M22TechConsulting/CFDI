<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <template id="report_payment_document_inherit_custom" inherit_id="account.report_payment_receipt_document">
            <xpath expr="//h3" position="after">
                <!--Datos del cliente y fiscales-->
                <!--___________________________________________________________-->
                <table class="table-borderless" width="100%">
                    <tr style="padding-top: 0px;!important">
                        <th class="border-o" rowspan="4">
                            <img t-if="o.company_id.logo" t-att-src="image_data_uri(o.company_id.logo)"
                                 style="height: 120px;width=50px" alt="Logo"/>
                        </th>
                        <th class="border-o" colspan="3">
                            <table width="100%">
                                <thead>
                                    <tr style="font-size: 14px;margin-top: 10px;!important;">
                                        <th t-if="o.company_id.vat" style="padding-bottom: 5px;!important"
                                            class="text-start border-o" t-esc="'RFC: ' + o.company_id.vat"/>
                                        <th class="text-start border-o"
                                            t-esc="'Regimen fiscal: ({}) {}'.format(o.company_id.l10n_mx_edi_fiscal_regime, dict(o.company_id._fields['l10n_mx_edi_fiscal_regime']._description_selection(o.env)).get(o.company_id.l10n_mx_edi_fiscal_regime))"/>
                                    </tr>
                                </thead>
                            </table>
                        </th>
                    </tr>
                    <tr>
                        <td class="border-o"/>
                        <td class="border-o" width="50%"
                            style="border-left: 1px solid #000;padding-left: 10px;!important">
                            <table style="margin-top: 10px;!important" width="100%">
                                <thead>
                                    <tr style="font-size: 16px;">
                                        <th colspan="2" class="text-center border-o">Datos del cliente</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border-o" style="font-size: 12px;">
                                            <strong t-esc="o.partner_id.name"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="border-o" style="font-size: 12px;">
                                            <strong t-esc="'RFC: {}'.format(o.partner_id.vat)"/>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="font-size: 12px;">
                                            <strong t-esc="'Uso de CFDI:' "/>
                                            <span t-esc="'({}) {}'.format(o.l10n_mx_edi_usage, dict(o._fields['l10n_mx_edi_usage']._description_selection(o.env)).get(o.l10n_mx_edi_usage))"/>
                                        </td>
                                    </tr>

                                </tbody>
                            </table>
                        </td>

                        <td width="50%"
                            style="border-left: 1px solid #000;border-right: 1px solid #000;padding-left: 10px;padding-right: 10px;!important">
                            <table width="100%">
                                <thead>
                                    <tr style="font-size: 16px;">
                                        <th colspan="2" class="text-center border-o">Comprobante fiscal
                                            digital
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border-o" colspan="2" width="100%" style="font-size: 12px;">
                                            <strong t-esc="'Fecha y hora:' "/>
                                            <span t-esc="o.date"/>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="border-o" colspan="2" width="100%" style="font-size: 12px;">
                                            <strong t-esc="'Lugar de expediciÃ³n:' "/>
                                            <span t-esc="o.company_id.zip"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </table>
                <!--___________________________________________________________-->
            </xpath>

            <xpath expr="//div/div" position="inside">
              <div class="row">
                <div class="col-6" t-if="o.currency_id">
                  Moneda de pago: <span t-esc="o.currency_id.name"/>
                </div>
                        <!--<div class="col-6" t-if="o.ref">-->
                        <!--    Memo: <span t-field="o.ref"/>-->
                        <!-- </div>-->
              </div>
            </xpath>

            <xpath expr="//table" position="replace">
                <t t-if="o.move_id.l10n_mx_edi_cfdi_uuid">
                    <t t-set="docs_related"
                       t-value="cfdi_vals.get('cfdi_node') and cfdi_vals['cfdi_node'].Complemento.xpath('//pago10:DoctoRelacionado', namespaces={'pago10': 'http://www.sat.gob.mx/Pagos'})"/>
                    <!-- Section to bank accounts-->
                    <t t-set="vat_em"
                       t-value="docs_related[0].getparent().get('RfcEmisorCtaOrd', '') if docs_related else ''"/>
                    <t t-set="bank_em"
                       t-value="docs_related[0].getparent().get('NomBancoOrdExt', '') if docs_related else ''"/>
                    <t t-set="acc_em"
                       t-value="docs_related[0].getparent().get('CtaOrdenante', '') if docs_related else ''"/>
                    <t t-set="vat_re"
                       t-value="docs_related[0].getparent().get('RfcEmisorCtaBen', '') if docs_related else ''"/>
                    <t t-set="acc_re"
                       t-value="docs_related[0].getparent().get('CtaBeneficiario', '') if docs_related else ''"/>
                    <table class="table table-sm" t-if="acc_em or acc_re">
                        <thead>
                            <tr>
                                <th t-if="vat_em"><t
                                        t-esc="o.company_id.account_fiscal_country_id.vat_label or 'VAT'"/><span>
                                    Emitter Acc. Ord.</span></th>
                                <th t-if="bank_em">Bank Name Acc. Ord.</th>
                                <th t-if="acc_em">Account Ord.</th>
                                <th t-if="vat_re"><t
                                        t-esc="o.company_id.account_fiscal_country_id.vat_label or 'VAT'"/> <span>
                                    Emitter Acc. Ben.</span></th>
                                <th t-if="acc_re">Account Ben.</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td t-if="vat_em"><span t-esc="vat_em"/></td>
                                <td t-if="bank_em"><span t-esc="bank_em"/></td>
                                <td t-if="acc_em"><span t-esc="acc_em"/></td>
                                <td t-if="vat_re"><span t-esc="vat_re"/></td>
                                <td t-if="acc_re"><span t-esc="acc_re"/></td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- Finish section to bank accounts-->
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>UUID</th>
                                <th class="text-end">Partiality</th>
                                <th class="text-end">Previous balance</th>
                                <th class="text-end">Amount Paid</th>
                                <th class="text-end">Balance</th>
                                <th>Currency</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr t-foreach="docs_related" t-as="inv">
                                <t t-set="inv_currency"
                                   t-value="o.env['res.currency'].search([('name', '=', inv.get('MonedaDR'))], limit=1)"/>
                                <td><span
                                        t-esc="o.reconciled_invoice_ids.filtered(lambda i: i.l10n_mx_edi_cfdi_uuid == inv.get('IdDocumento')).name or ''"/></td>
                                <td><span t-esc="inv.get('IdDocumento')"/></td>
                                <td class="text-end"><span t-esc="inv.get('NumParcialidad', '')"/></td>
                                <td class="text-end">
                                    <span t-esc="float(inv.get('ImpSaldoAnt', ''))"
                                          t-options="{'widget': 'monetary', 'display_currency': inv_currency}"/>
                                </td>
                                <td class="text-end">
                                    <span t-esc="float(inv.get('ImpPagado', ''))"
                                          t-options="{'widget': 'monetary', 'display_currency': inv_currency}"/>
                                </td>
                                <td class="text-end">
                                    <span t-esc="float(inv.get('ImpSaldoInsoluto', ''))"
                                          t-options="{'widget': 'monetary', 'display_currency': inv_currency}"/>
                                </td>
                                <td><span t-esc="inv.get('MonedaDR')"/></td>
                            </tr>
                        </tbody>
                    </table>
                </t>
                <t t-if="o.move_id.l10n_mx_edi_cfdi_uuid">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Invoice Date</th>
                                <th>Invoice Number</th>
                                <th class="text-end">Original Amount</th>
                                <th class="text-end">Amount Paid</th>
                                <th class="text-end">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr t-foreach="o.reconciled_invoice_ids" t-as="inv">
                                <td><span t-field="inv.invoice_date"/></td>
                                <td><span t-field="inv.name"/></td>
                                <td class="text-end"><span t-field="inv.amount_total"/></td>
                                <td class="text-end"><span t-esc="inv.amount_total - inv.amount_residual"
                                                           t-options="{'widget': 'monetary', 'display_currency': inv.currency_id}"/></td>
                                <td class="text-end"><span t-field="inv.amount_residual"/></td>
                            </tr>
                        </tbody>
                    </table>
                </t>
            </xpath>
        </template>


    </data>
</odoo>